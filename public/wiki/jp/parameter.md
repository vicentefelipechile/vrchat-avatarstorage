# アバターパラメータ (Expression Parameters)

<span class="badge badge-blue">ロジック</span> <span class="badge badge-yellow">最適化</span>

## これはなに？
**Expression Parameters**（または単にパラメータ）は、VRChatアバターの「メモリ」として機能する変数です[1]。これらは、**Expression Menu**（ゲーム内のラジアルメニュー）と**Animator Controller**（アニメーションを再生させるロジック）の間の架け橋として機能します。

メニューでオプション（例：「シャツを脱ぐ」）を選択すると、メニューはパラメータの値（例：`Shirt = 0`）を変更し、Animatorはその変更を読み取って対応するアニメーションを実行します。

## パラメータの種類
主に使用できるデータ型は3つあり、それぞれメモリコストが異なります[2]。

| 型 | 説明 | メモリコスト | 一般的な用途 |
| :--- | :--- | :--- | :--- |
| **Bool** | 真または偽 (On/Off)。 | 1 bit | 単純な切り替え（服、小物）。 |
| **Int** | 整数 (0 ～ 255)。 | 8 bits | 複数の選択肢がある衣装変更、段階的なスライダー。 |
| **Float**| 小数 (0.0 ～ 1.0)。 | 8 bits | 連続的なスライダー（太さ、色相、Radial Puppet）。 |

## メモリ制限 (Synced Bits)
VRChatでは、アバターごとに**256ビット**の同期データという厳しい制限があります[2]。
- **同期 (Synced):** 値がネットワークを通じて他のプレイヤーに送信されるパラメータ。シャツを脱いだら、他の人にもそれが見えるようにしたい場合です。
- **非同期 (Local):** 自分のPC上にのみ存在するパラメータ。他人に見せる必要のない内部ロジックに便利です。

> [!WARNING]
> メモリ制限を超えると、アバターをアップロードできなくなるか、余分なパラメータが機能しなくなります。可能な場合は`Int`の代わりに`Bool`を使用して最適化してください。

## 高度な使用法
メニューから服を制御するだけでなく、パラメータは以下によっても制御できます。
- **PhysBones:** 誰かがあなたの耳や髪に触れたかを検出するため[3]。
- **Contacts:** 衝突を検出するため（[SPS](./sps.md)や[PCS](./pcs.md)システムなど）。
- **OSC:** 外部プログラム（心拍数モニター、フェイシャルトラッキング、Spotifyなど）からデータを受信するため[3]。

## 作成方法
1. Unityプロジェクトで、`Assets`を右クリックします。
2. `Create` > `VRChat` > `Avatars` > `Expression Parameters`に移動します。
3. 必要なパラメータを追加します（例："Outfit", "Sword", "HueShift"）。
4. このファイルをアバターの**VRC Avatar Descriptor**コンポーネントの「Expressions」セクションに割り当てます。

## 制限と一般的な問題

### なぜ256ビットの制限があるのですか？
VRChatは主に**ネットワークの最適化**のためにこの制限を設けています[1]。すべての同期パラメータは、インスタンス内の他のすべてのプレイヤーに送信する必要があります。制限がなかった場合：
- 80人のプレイヤーの位置と状態を更新するために必要な帯域幅が維持できなくなります。
- 回線速度が遅いユーザーは、極度のラグや切断に苦しむことになります。
- 過剰なネットワークデータ処理により、全体的なFPSパフォーマンスが低下します。

### 複雑なアセットとの競合 (GoGo Loco, SPS, ダンス)
1つのアバターに複数の「重い」システムを組み合わせると、頻繁に問題が発生します。

1.  **パラメータの枯渇 (Parameter Exhaustion):**
    **GoGo Loco**のようなアセットは、かなりの量のメモリを消費します。そこにSPS、複雑なダンスシステム、服の切り替えを追加しようとすると、256同期ビットを超えるのは非常に簡単です。
    *   *結果:* VRChatはアバターのアップロードをブロックするか、最後にインストールされたコンポーネントが機能しなくなります。

2.  **ロジックの競合:**
    *   **GoGo Loco:** ベースの移動レイヤーや古いバージョンのアセットと競合すると、アバターが床に「沈む」か浮いてしまう可能性があります[4]。
    *   **SPS (Super Plug Shader):** SPSとConstraintsを組み合わせると、VRChatが物理演算とハプティクスの更新を処理する方法が原因で、接触点で「ジッター」（急速な揺れ）が発生する可能性があります[5]。

3.  **パフォーマンスランク:**
    *   **SPS:** しばしば追加のライトやレンダラーを必要とし、アバターのパフォーマンスランクを即座に「Very Poor」に下げる可能性があります。
    *   **GoGo Loco:** Animator Controllerに複数のレイヤーを追加します。グラフィックへの影響はそれほど大きくありませんが、アニメーションロジックの処理によるCPU使用率が増加します[4]。

> [!TIP]
> **VRCFury**のようなツールは、これらの競合を管理するために不可欠です。VRCFuryはコントローラーとパラメータのマージを自動化し（「非破壊ワークフロー」）、人為的エラーを減らし、可能な限りメモリ使用量を最適化します。

## 最適化とコツ: ビット使用量を減らす方法

機能を犠牲にせずに256ビットの制限に達しないように、クリエイターはいくつかの賢いテクニックを使用します。最も一般的なのは、**相互排他的な状態を組み合わせる**ことです。

#### 「シングルInt」のトリック (Single Int)
アバター用に10種類の異なるシャツがあると想像してください。
*   **非効率な方法 (Bools):** 10個の`Bool`パラメータを作成します (Shirt1, Shirt2... Shirt10)。
    *   *コスト:* 10 Bits。
    *   *欠点:* 服が増えるたびに1ビット消費します。
*   **効率的な方法 (Int):** `Top_Clothing`という名前の**1つ**の`Int`パラメータを作成します。
    *   *コスト:* 8 Bits (Intなので常に8ビット)。
    *   *利点:* 同じ8ビットを使用して最大**255枚のシャツ**を持つことができます！
    *   *仕組み:* Animatorで、値が1ならシャツA、2ならシャツB...となるように設定します。

> [!NOTE]
> **黄金律:** 同時に使用できないオプション（例：服の種類、目の色）が8つ以上ある場合は、`Int`を使用してください。8つ未満の場合は、個別の`Bool`を使用してください。

#### 基本的な設定例
服の色選択機能を作りたい場合：
1.  `ColorBoots`という**Int**パラメータを作成します。
2.  **Expression Menu**で、サブメニューまたは「Radial Puppet」コントロールを作成します（正確な変更には正確な値を設定するボタンの方が適しています）。
3.  メニューボタンを設定します：
    *   "Red" ボタン -> Sets `ColorBoots` to 1.
    *   "Blue" ボタン -> Sets `ColorBoots` to 2.
    *   "Black" ボタン -> Sets `ColorBoots` to 3.
4.  **Animator (FX Layer)**で：
    *   `Any State`から色のステートへのトランジションを作成します。
    *   赤の条件: `ColorBoots` equals 1.
    *   青の条件: `ColorBoots` equals 2.

この方法なら、合計予算のうちたった8ビットを費やすだけで複数のオプションを制御できます！

## 概要表: どのタイプを使うべき？

| ユースケース | 推奨タイプ | 理由 |
| :--- | :--- | :--- |
| **1つのオブジェクトの切替** (眼鏡、帽子) | `Bool` | シンプルで直接的。1ビット消費。 |
| **服セレクター** (シャツA, B, C...) | `Int` | たった8ビットで数百のオプションが可能。 |
| **段階的な変更** (太さ、色、明るさ) | `Float` | 小数値 (0.0 ～ 1.0) が必要なため。 |
| **複雑な状態** (ダンス、AFK、エモート) | `Int` | 複数の条件を持つステートマシンに最適。 |
| **独立した切替** (8個未満) | `Bool` | 数が少なく、互いに打ち消し合わない場合は設定が簡単。 |

---

## 参考文献

[1] VRChat. (n.d.). *Expression Parameters*. VRChat Documentation. https://docs.vrchat.com/docs/expression-parameters

[2] VRChat. (n.d.). *Avatar Parameter Driver*. VRChat Documentation. https://docs.vrchat.com/docs/avatar-parameter-driver

[3] VRChat. (n.d.). *OSC Overview*. VRChat Documentation. https://docs.vrchat.com/docs/osc-overview

[4] Franada. (n.d.). *GoGo Loco Documentation*. https://www.3d.franada.com/gogoloco

[5] VRCFury. (n.d.). *SPS - Super Plug Shader*. VRCFury Documentation. https://vrcfury.com/components/sps
