# Параметры Аватара (Expression Parameters)

<span class="badge badge-blue">Логика</span> <span class="badge badge-yellow">Оптимизация</span>

## Что это такое?
**Expression Parameters** (или просто параметры) — это переменные, которые служат "памятью" для вашего аватара в VRChat [1]. Они действуют как мост между **Меню Выражений** (радиальное меню в игре) и **Animator Controller** (логика, воспроизводящая анимации).

Когда вы выбираете опцию в меню (например, "Снять рубашку"), меню изменяет значение параметра (например, `Shirt = 0`), и Animator считывает это изменение для запуска соответствующей анимации.

## Типы Параметров
Существует три основных типа данных, которые можно использовать, каждый с разной стоимостью памяти [2]:

| Тип | Описание | Стоимость памяти | Обычное использование |
| :--- | :--- | :--- | :--- |
| **Bool** | Истина или Ложь (Вкл/Выкл). | 1 бит | Простые переключатели (одежда, предметы). |
| **Int** | Целые числа (от 0 до 255). | 8 бит | Смена одежды с множеством вариантов, пошаговые слайдеры. |
| **Float**| Десятичные числа (от 0.0 до 1.0). | 8 бит | Плавные слайдеры (толщина, оттенок, radial puppet). |

## Лимит Памяти (Synced Bits)
VRChat устанавливает строгий лимит в **256 бит** синхронизируемых данных на аватар [2].
- **Синхронизируемые (Synced):** Параметры, значение которых отправляется другим игрокам по сети. Если вы снимаете рубашку, вы хотите, чтобы другие это видели.
- **Несинхронизируемые (Local):** Параметры, существующие только на вашем ПК. Полезны для внутренней логики, которую не нужно видеть другим.

> [!WARNING]
> Если вы превысите лимит памяти, вы не сможете загрузить аватар, или лишние параметры перестанут работать. Оптимизируйте, используя `Bool` вместо `Int`, когда это возможно.

## Продвинутое Использование
Помимо управления одеждой из меню, параметры могут контролироваться через:
- **PhysBones:** Чтобы определить, трогает ли кто-то ваше ухо или волосы [3].
- **Contacts:** Для обнаружения коллизий (как в системах [SPS](./sps.md) или [PCS](./pcs.md)).
- **OSC:** Для получения данных от внешних программ (мониторы сердечного ритма, отслеживание лица или Spotify) [3].

## Как Создать
1. В вашем проекте Unity нажмите правой кнопкой мыши в `Assets`.
2. Перейдите в `Create` > `VRChat` > `Avatars` > `Expression Parameters`.
3. Добавьте нужные параметры (например, "Outfit", "Sword", "HueShift").
4. Назначьте этот файл в компоненте **VRC Avatar Descriptor** вашего аватара, в секции "Expressions".

## Ограничения и Частые Проблемы

### Почему существует лимит в 256 бит?
VRChat вводит этот лимит в основном для **оптимизации сети** [1]. Каждый синхронизируемый параметр должен быть отправлен всем другим игрокам в инстансе. Если бы лимита не было:
- Пропускная способность, необходимая для обновления позиции и состояния 80 игроков, была бы неподъемной.
- Пользователи с медленным интернетом страдали бы от экстремальных лагов или разрывов соединения.
- Общая производительность (FPS) упала бы из-за чрезмерной обработки сетевых данных.

### Конфликты со Сложными Ассетами (GoGo Loco, SPS, Танцы)
При объединении нескольких "тяжелых" систем в одном аватаре часто возникают проблемы:

1.  **Исчерпание Параметров (Parameter Exhaustion):**
    Ассеты, такие как **GoGo Loco**, потребляют значительное количество памяти. Если вы попытаетесь добавить SPS, сложную систему танцев и переключатели одежды, очень легко превысить 256 синхронизируемых бит.
    *   *Последствие:* VRChat заблокирует загрузку аватара, или последние установленные компоненты не будут работать.

2.  **Конфликты Логики:**
    *   **GoGo Loco:** Может вызвать "погружение" аватара в пол или левитацию при конфликтах с базовыми слоями локомоции или старыми версиями ассета [4].
    *   **SPS (Super Plug Shader):** Сочетание SPS с Constraints может вызвать "дрожание" в точках контакта из-за того, как VRChat обрабатывает обновления физики и хаптики [5].

3.  **Рейтинг Производительности (Performance Rank):**
    *   **SPS:** Часто требует дополнительных источников света или рендереров, что может сразу снизить рейтинг аватара до "Very Poor".
    *   **GoGo Loco:** Добавляет множество слоев в Animator Controller. Хотя это не так сильно влияет на графику, это увеличивает нагрузку на ЦП для обработки логики анимации [4].

> [!TIP]
> Инструменты, такие как **VRCFury**, необходимы для управления этими конфликтами. VRCFury автоматизирует слияние контроллеров и параметров ("Non-Destructive Workflow"), уменьшая человеческие ошибки и оптимизируя использование памяти, где это возможно.

## Оптимизация и Трюки: Как уменьшить использование бит

Чтобы избежать достижения лимита в 256 бит без жертв функционалом, создатели используют несколько умных техник. Самая распространенная — **объединение взаимоисключающих состояний**.

#### Трюк "Одиночный Int" (Single Int)
Представьте, что у вас есть 10 разных рубашек для аватара.
*   **Неэффективный способ (Bools):** Вы создаете 10 параметров `Bool` (Shirt1, Shirt2... Shirt10).
    *   *Стоимость:* 10 Бит.
    *   *Недостаток:* Вы тратите 1 бит на каждую дополнительную вещь.
*   **Эффективный способ (Int):** Вы создаете **1** параметр `Int` под названием `Top_Clothing`.
    *   *Стоимость:* 8 Бит (всегда, так как это Int).
    *   *Преимущество:* Вы можете иметь до **255 рубашек**, используя те же 8 бит!
    *   *Как это работает:* В Animator вы настраиваете: если значение 1 — активируется Рубашка А, если 2 — Рубашка Б и т.д.

> [!NOTE]
> **Золотое правило:** Если у вас более 8 опций, которые нельзя использовать одновременно (например, типы одежды, цвет глаз), используйте `Int`. Если меньше 8 — используйте отдельные `Bool`.

#### Пример Базовой Настройки
Если вы хотите создать селектор цветов для одежды:
1.  Создайте параметр **Int** с именем `ColorBoots`.
2.  В вашем **Expression Menu** создайте подменю или контроль типа "Radial Puppet" (хотя для точных изменений лучше кнопки).
3.  Настройте кнопки меню:
    *   Кнопка "Красный" -> Sets `ColorBoots` to 1.
    *   Кнопка "Синий" -> Sets `ColorBoots` to 2.
    *   Кнопка "Черный" -> Sets `ColorBoots` to 3.
4.  В **Animator (FX Layer)**:
    *   Создайте переходы от `Any State` к состояниям цвета.
    *   Условие для Красного: `ColorBoots` equals 1.
    *   Условие для Синего: `ColorBoots` equals 2.

Так вы управляете множеством опций, тратя всего 8 бит вашего общего бюджета!

## Сводная Таблица: Какой тип использовать?

| Сценарий | Рекомендуемый Тип | Почему? |
| :--- | :--- | :--- |
| **Вкл/Выкл 1 объект** (Очки, шляпа) | `Bool` | Просто и прямолинейно. Тратит 1 бит. |
| **Селектор Одежды** (Рубашка А, Б, В...) | `Int` | Позволяет сотни вариантов, тратя всего 8 бит. |
| **Плавные изменения** (Толщина, Цвет, Яркость) | `Float` | Необходимо для десятичных значений (0.0 до 1.0). |
| **Сложные состояния** (Танцы, AFK, Эмоции) | `Int` | Идеально для машин состояний с множеством условий. |
| **Независимые переключатели** (< 8 объектов) | `Bool` | Если их мало, и они не отменяют друг друга, проще настроить. |

---

## Ссылки

[1] VRChat. (н.д.). *Expression Parameters*. VRChat Documentation. https://docs.vrchat.com/docs/expression-parameters

[2] VRChat. (н.д.). *Avatar Parameter Driver*. VRChat Documentation. https://docs.vrchat.com/docs/avatar-parameter-driver

[3] VRChat. (н.д.). *OSC Overview*. VRChat Documentation. https://docs.vrchat.com/docs/osc-overview

[4] Franada. (н.д.). *GoGo Loco Documentation*. https://www.3d.franada.com/gogoloco

[5] VRCFury. (н.д.). *SPS - Super Plug Shader*. VRCFury Documentation. https://vrcfury.com/components/sps
